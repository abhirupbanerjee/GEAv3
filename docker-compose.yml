networks:
  geav3_network:
    name: geav3_network
    driver: bridge

volumes:
  traefik_acme:
  feedback_db_data:

services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    networks:
      - geav3_network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/traefik.yml:ro
      - traefik_acme:/acme
    environment:
      - LETS_ENCRYPT_EMAIL=mailabhirupbanerjee@gmail.com

  feedback_db:
    image: postgres:15-alpine
    container_name: feedback_db
    restart: unless-stopped
    networks:
      - geav3_network
    environment:
      POSTGRES_DB: ${FEEDBACK_DB_NAME}
      POSTGRES_USER: ${FEEDBACK_DB_USER}
      POSTGRES_PASSWORD: ${FEEDBACK_DB_PASSWORD}
    volumes:
      - feedback_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${FEEDBACK_DB_USER} -d ${FEEDBACK_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - WIKI_URL=${WIKI_URL}
        - DMS_URL=${DMS_URL}
        - GIT_URL=${GIT_URL}
        - HELPDESK_URL=${HELPDESK_URL}
        - CHATBOT_URL=${CHATBOT_URL}
        - GOG_URL=${GOG_URL}
        - SERVICES_URL=${SERVICES_URL} 
        - ESERVICES_URL=${ESERVICES_URL}
        - CONSTITUTION_URL=${CONSTITUTION_URL}
        - SITE_NAME=${SITE_NAME}
        - CONTACT_EMAIL=${CONTACT_EMAIL}
        - ABOUT_CONTACT_EMAIL=${ABOUT_CONTACT_EMAIL}
        - COPYRIGHT_YEAR=${COPYRIGHT_YEAR}
        - FEEDBACK_DB_HOST=feedback_db
        - FEEDBACK_DB_PORT=5432
        - FEEDBACK_DB_NAME=feedback
        - FEEDBACK_DB_USER=feedback_user
        - FEEDBACK_DB_PASSWORD=${FEEDBACK_DB_PASSWORD}
        - NEXT_PUBLIC_FRONTEND_URL= ${NEXT_PUBLIC_FRONTEND_URL}
        - NEXT_PUBLIC_SITE_NAME= ${NEXT_PUBLIC_SITE_NAME}
        - NEXT_PUBLIC_SITE_SHORT_NAME= ${NEXT_PUBLIC_SITE_SHORT_NAME}
        - NEXT_PUBLIC_BASE_DOMAIN= ${NEXT_PUBLIC_BASE_DOMAIN}
    container_name: frontend
    restart: unless-stopped
    networks:
      - geav3_network
    environment:
      # Runtime environment variables for database connection
      - FEEDBACK_DB_HOST=feedback_db
      - FEEDBACK_DB_PORT=${FEEDBACK_DB_PORT}
      - FEEDBACK_DB_NAME=${FEEDBACK_DB_NAME}
      - FEEDBACK_DB_USER=${FEEDBACK_DB_USER}
      - FEEDBACK_DB_PASSWORD=${FEEDBACK_DB_PASSWORD}
      - OSTICKET_API_URL=${OSTICKET_API_URL}
      - OSTICKET_API_KEY=${OSTICKET_API_KEY}
      - OSTICKET_SYSTEM_EMAIL=${OSTICKET_SYSTEM_EMAIL}
    depends_on:
      feedback_db:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`gea.abhirup.app`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

