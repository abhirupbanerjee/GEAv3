networks:
  geav3_network:
    name: geav3_network
    driver: bridge

volumes:
  traefik_acme:
  feedback_db_data:
  redis_data:

services:
  traefik:
    image: traefik:v3.6
    container_name: traefik
    restart: unless-stopped
    networks:
      - geav3_network
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik.yml:/traefik.yml:ro
      - traefik_acme:/acme
    environment:
      - LETS_ENCRYPT_EMAIL=mailabhirupbanerjee@gmail.com

  feedback_db:
    image: postgres:16-alpine
    container_name: feedback_db
    restart: unless-stopped
    networks:
      - geav3_network
    environment:
      POSTGRES_DB: ${FEEDBACK_DB_NAME}
      POSTGRES_USER: ${FEEDBACK_DB_USER}
      POSTGRES_PASSWORD: ${FEEDBACK_DB_PASSWORD}
    volumes:
      - feedback_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${FEEDBACK_DB_USER} -d ${FEEDBACK_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7.4.4-alpine
    container_name: redis
    restart: unless-stopped
    networks:
      - geav3_network
    volumes:
      - redis_data:/data
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgbouncer:
    image: edoburu/pgbouncer:v1.23.1-p3
    container_name: pgbouncer
    restart: unless-stopped
    networks:
      - geav3_network
    environment:
      - DATABASE_URL=postgres://${FEEDBACK_DB_USER}:${FEEDBACK_DB_PASSWORD}@feedback_db:5432/${FEEDBACK_DB_NAME}
      - POOL_MODE=transaction
      - MAX_CLIENT_CONN=200
      - DEFAULT_POOL_SIZE=20
      - MIN_POOL_SIZE=5
      - RESERVE_POOL_SIZE=5
      - AUTH_TYPE=scram-sha-256
    depends_on:
      feedback_db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "pg_isready", "-h", "localhost", "-p", "5432"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Using simple form (VAR instead of VAR=${VAR}) so .env takes precedence over empty shell variables
        - DMS_URL
        - GIT_URL
        - CHATBOT_URL
        - GOG_URL
        - ESERVICES_URL
        - CONSTITUTION_URL
        - SITE_NAME
        - CONTACT_EMAIL
        - ABOUT_CONTACT_EMAIL
        - COPYRIGHT_YEAR
        - FEEDBACK_DB_HOST=feedback_db
        - FEEDBACK_DB_PORT=5432
        - FEEDBACK_DB_NAME=feedback
        - FEEDBACK_DB_USER=feedback_user
        - FEEDBACK_DB_PASSWORD=${FEEDBACK_DB_PASSWORD}
        - NEXT_PUBLIC_FRONTEND_URL= ${NEXT_PUBLIC_FRONTEND_URL}
        - NEXT_PUBLIC_SITE_NAME= ${NEXT_PUBLIC_SITE_NAME}
        - NEXT_PUBLIC_SITE_SHORT_NAME= ${NEXT_PUBLIC_SITE_SHORT_NAME}
        - NEXT_PUBLIC_BASE_DOMAIN= ${NEXT_PUBLIC_BASE_DOMAIN}
        - NEXT_PUBLIC_ABOUT_CONTACT_EMAIL=${NEXT_PUBLIC_ABOUT_CONTACT_EMAIL}
        - NEXT_PUBLIC_COPYRIGHT_YEAR=${NEXT_PUBLIC_COPYRIGHT_YEAR}
        # NEW - Phase 2b: SendGrid
        - SENDGRID_API_KEY=${SENDGRID_API_KEY}
        - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL}
        - SENDGRID_FROM_NAME=${SENDGRID_FROM_NAME}
        
        # NEW - Phase 2b: Service Admin
        - SERVICE_ADMIN_EMAIL=${SERVICE_ADMIN_EMAIL}
        
        # NEW - Phase 2b: File Upload
        - MAX_FILE_SIZE=${MAX_FILE_SIZE}
        - MAX_TOTAL_UPLOAD_SIZE=${MAX_TOTAL_UPLOAD_SIZE}
        - ALLOWED_FILE_TYPES=${ALLOWED_FILE_TYPES}
        
        # NEW - Phase 2b: Rate Limiting
        - EA_SERVICE_RATE_LIMIT=${EA_SERVICE_RATE_LIMIT}
        - GRIEVANCE_RATE_LIMIT=${GRIEVANCE_RATE_LIMIT}

        # Service Request Configuration
        - NEXT_PUBLIC_SERVICE_REQUEST_ENTITY_ID=${NEXT_PUBLIC_SERVICE_REQUEST_ENTITY_ID:-AGY-005}

        # NEW - Phase 2b: API Base URLs
        - API_BASE_URL=${API_BASE_URL}
        - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
    container_name: frontend
    restart: unless-stopped
    networks:
      - geav3_network
    environment:
      # Runtime environment variables for database connection (via PgBouncer)
      - FEEDBACK_DB_HOST=pgbouncer
      - FEEDBACK_DB_PORT=5432
      - FEEDBACK_DB_NAME=${FEEDBACK_DB_NAME}
      - FEEDBACK_DB_USER=${FEEDBACK_DB_USER}
      - FEEDBACK_DB_PASSWORD=${FEEDBACK_DB_PASSWORD}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_SESSION_SECRET=${ADMIN_SESSION_SECRET}

      # Redis caching
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # NextAuth environment variables (runtime only)
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      # Microsoft OAuth
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID}

      # Database connection for NextAuth (via PgBouncer)
      - DB_HOST=pgbouncer
      - DB_PORT=5432
      - DB_NAME=feedback
      - DB_USER=feedback_user
      - DB_PASSWORD=${FEEDBACK_DB_PASSWORD}

      # External API Access
      - EXTERNAL_API_KEY=${EXTERNAL_API_KEY}

    depends_on:
      feedback_db:
        condition: service_healthy
      pgbouncer:
        condition: service_healthy
      redis:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${FRONTEND_DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

      # Rate limiting for external API (100 requests/hour with burst of 20)
      - "traefik.http.middlewares.external-api-ratelimit.ratelimit.average=100"
      - "traefik.http.middlewares.external-api-ratelimit.ratelimit.burst=20"
      - "traefik.http.middlewares.external-api-ratelimit.ratelimit.period=1h"

      # External API router (applies rate limit only to /api/external/*)
      - "traefik.http.routers.external-api.rule=Host(`${FRONTEND_DOMAIN}`) && PathPrefix(`/api/external/`)"
      - "traefik.http.routers.external-api.entrypoints=websecure"
      - "traefik.http.routers.external-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.external-api.middlewares=external-api-ratelimit"
      - "traefik.http.routers.external-api.service=frontend"
      - "traefik.http.routers.external-api.priority=200"

